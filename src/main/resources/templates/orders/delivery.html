<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments :: head('Delivery Tracking')}"></head>

<body>
    <header th:replace="~{fragments :: header('Delivery Tracking', 'Manage order preparation and delivery')}"></header>

    <div class="container mb-5">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 pt-4 pb-1">
                <h5 class="fw-bold">Active Orders</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th>Order #</th>
                                <th>Store</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="order : ${orders}">
                                <td>
                                    <a href="javascript:void(0)" class="text-decoration-none fw-bold"
                                        th:onclick="'showOrderDetails(' + ${order.id} + ')'"
                                        th:text="${order.orderNumber}">ORD-000</a>
                                </td>
                                <td th:text="${order.store != null ? order.store.name : 'Unknown Store'}">Store</td>
                                <td th:text="${'$' + #numbers.formatDecimal(order.totalAmount, 1, 2)}">$0.00</td>
                                <td>
                                    <span th:id="'status-' + ${order.id}" class="badge"
                                        th:classappend="${order.status == 'DELIVERED' ? 'bg-success' : 'bg-warning'}"
                                        th:text="${order.status}">PENDING</span>
                                </td>
                                <td class="d-flex gap-2">
                                    <div th:id="'actions-' + ${order.id}">
                                        <button th:if="${order.status == 'PENDING'}" class="btn btn-sm btn-primary"
                                            th:onclick="'updateOrderStatus(' + ${order.id} + ', \'PREPARED\')'">Prepare</button>

                                        <button th:if="${order.status == 'PREPARED'}"
                                            class="btn btn-sm btn-info text-white"
                                            th:onclick="'updateOrderStatus(' + ${order.id} + ', \'DELIVERED\')'">Deliver</button>

                                        <span th:if="${order.status == 'DELIVERED'}"
                                            class="text-success small fw-bold">Ready</span>
                                    </div>
                                    <div>
                                        <button class="btn btn-sm btn-primary bi bi-printer-fill" th:onclick="'printOrder(' + ${order.id} + ')'">Print</button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Order Details: <span id="modalOrderNumber"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Store:</strong> <span id="modalStoreName"></span>
                        </div>
                        <div class="col-md-6 text-end">
                            <strong>Status:</strong> <span id="modalStatus" class="badge"></span>
                        </div>
                    </div>
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Asset</th>
                                <th>Qty</th>
                                <th>Unit Price</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody id="modalItemsBody">
                        </tbody>
                        <tfoot>
                            <tr>
                                <th colspan="3" class="text-end">Grand Total:</th>
                                <th id="modalGrandTotal"></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function updateOrderStatus(orderId, status) {
            if (!confirm(`Mark order as ${status.toLowerCase()}?`)) return;

            try {
                const response = await fetch(`/api/orders/${orderId}/status?status=${status}`, {
                    method: 'POST'
                });
                if (!response.ok) throw new Error('Failed to update status');

                // Refresh specific row parts if needed, or just reload
                window.location.reload();
            } catch (error) {
                console.error(error);
                alert('Error updating status');
            }
        }

        async function showOrderDetails(orderId) {
            try {
                const response = await fetch(`/api/orders/${orderId}`);
                if (!response.ok) throw new Error('Failed to fetch details');
                const order = await response.json();

                document.getElementById('modalOrderNumber').innerText = order.orderNumber;
                document.getElementById('modalStoreName').innerText = order.storeName;

                const statusBadge = document.getElementById('modalStatus');
                statusBadge.innerText = order.status;
                statusBadge.className = 'badge ' + (order.status === 'DELIVERED' ? 'bg-success' : 'bg-warning');

                const itemsBody = document.getElementById('modalItemsBody');
                itemsBody.innerHTML = '';
                order.items.forEach(item => {
                    const row = `<tr>
                        <td>${item.assetName}</td>
                        <td>${item.quantity}</td>
                        <td>$${item.unitPrice.toFixed(2)}</td>
                        <td>$${item.totalPrice.toFixed(2)}</td>
                    </tr>`;
                    itemsBody.innerHTML += row;
                });

                document.getElementById('modalGrandTotal').innerText = '$' + order.totalAmount.toFixed(2);

                const modal = new bootstrap.Modal(document.getElementById('orderDetailsModal'));
                modal.show();
            } catch (error) {
                console.error(error);
                alert('Error loading order details');
            }
        }

        async function printOrder(orderId) {
            try {
                const response = await fetch(`/delivery/print/${orderId}`, {
                    method: 'GET'
                });
                if (!response.ok) throw new Error('Failed to print order');
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `order_${orderId}.pdf`;
                link.click();
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error(error);
                alert('Error printing order');
            }
        }
    </script>
    <footer th:replace="~{fragments :: footer}"></footer>
</body>

</html>