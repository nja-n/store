<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments :: head('Administration Setup')}"></head>

<body>
    <header th:replace="~{fragments :: header('Administration Setup', 'Manage Companies, Stores, and Users')}"></header>

    <div class="container mb-5">
        <ul class="nav nav-tabs" id="setupTabs" role="tablist">
            <!-- ... (tab items) ... -->
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="company-tab" data-bs-toggle="tab" data-bs-target="#company"
                    type="button" role="tab">Companies</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="store-tab" data-bs-toggle="tab" data-bs-target="#store" type="button"
                    role="tab">Stores</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="user-tab" data-bs-toggle="tab" data-bs-target="#user" type="button"
                    role="tab">Users</button>
            </li>
            <li class="nav-item">
                <a class="nav-link text-primary fw-bold" href="/stock">Stock Management â†’</a>
            </li>
        </ul>

        <div class="tab-content mt-3" id="setupContent">
            <!-- Company Tab -->
            <div class="tab-pane fade show active" id="company" role="tabpanel">
                <div class="card border-0 shadow-sm mt-3">
                    <div class="card-body">
                        <h3>Add Company</h3>
                        <form method="post" th:action="@{/admin/setup/company}" th:object="${company}">
                            <input type="hidden" id="companyId" name="id" />
                            <div class="mb-3">
                                <label for="companyName" class="form-label">Name</label>
                                <input type="text" class="form-control" id="companyName" name="name" th:field="*{name}">
                            </div>
                            <button type="submit" class="btn btn-primary">Save</button>
                        </form>
                    </div>
                </div>

                <h4 class="mt-4">Existing Companies</h4>
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="comp : ${companies}">
                            <td th:text="${comp.id}"></td>
                            <td th:text="${comp.name}"></td>
                            <td>
                                <button class="btn btn-sm btn-warning"
                                    th:onclick="editCompany([[${comp.id}]], [[${comp.name}]])">Edit</button>
                                <form th:action="@{/admin/setup/company/delete/{id}(id=${comp.id})}" method="post"
                                    style="display:inline;">
                                    <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                                </form>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Store Tab -->
            <div class="tab-pane fade" id="store" role="tabpanel">
                <div class="card border-0 shadow-sm mt-3">
                    <div class="card-body">
                        <h3>Add Store</h3>
                        <form method="post" th:action="@{/admin/setup/store}" th:object="${store}">
                            <input type="hidden" id="storeId" name="id" />
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="storeName" class="form-label">Name</label>
                                    <input type="text" class="form-control" id="storeName" name="name"
                                        th:field="*{name}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="storeGst" class="form-label">GST Number (Optional)</label>
                                    <input type="text" class="form-control" id="storeGst" name="gstNumber"
                                        th:field="*{gstNumber}">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="storeLocation" class="form-label">Location (Place)</label>
                                    <input type="text" class="form-control" id="storeLocation" name="location"
                                        th:field="*{location}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="storeAddress" class="form-label">Detailed Address</label>
                                    <input type="text" class="form-control" id="storeAddress" name="address"
                                        th:field="*{address}">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="storePerson" class="form-label">Contact Person</label>
                                    <input type="text" class="form-control" id="storePerson" name="contactPerson"
                                        th:field="*{contactPerson}">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="storeMobile" class="form-label">Mobile Number</label>
                                    <input type="text" class="form-control" id="storeMobile" name="mobileNumber"
                                        th:field="*{mobileNumber}">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="storeEmail" class="form-label">Email (Optional)</label>
                                    <input type="email" class="form-control" id="storeEmail" name="email"
                                        th:field="*{email}">
                                </div>
                            </div>
                            <div class="mb-3" sec:authorize="hasRole('ADMIN')">
                                <label for="storeCompany" class="form-label">Company</label>
                                <select class="form-select" id="storeCompany" name="companyId">
                                    <option value="">Select Company</option>
                                    <option th:each="comp : ${companies}" th:value="${comp.id}" th:text="${comp.name}">
                                    </option>
                                </select>
                                <div class="form-text">Required for system administrators. Company admins' stores are
                                    assigned automatically.</div>
                            </div>
                            <div class="mb-3 form-check">
                                <input type="checkbox" class="form-check-input" id="storeLoginEnabled"
                                    name="loginEnabled" th:field="*{loginEnabled}">
                                <label class="form-check-label" for="storeLoginEnabled">Enable Store Login (Automated
                                    User Creation)</label>
                            </div>
                            <button type="submit" class="btn btn-primary">Save</button>
                        </form>
                    </div>
                </div>

                <h4 class="mt-4">Existing Stores</h4>
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Location/GST</th>
                            <th>Contact</th>
                            <th>Login</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="st : ${stores}">
                            <td th:text="${st.id}"></td>
                            <td th:text="${st.name}"></td>
                            <td>
                                <div th:text="${st.location}"></div>
                                <small class="text-muted" th:text="${st.gstNumber}"></small>
                            </td>
                            <td>
                                <div th:text="${st.contactPerson}"></div>
                                <small class="text-muted" th:text="${st.mobileNumber}"></small>
                            </td>
                            <td>
                                <span th:if="${st.loginEnabled}" class="badge bg-success">Enabled</span>
                                <span th:unless="${st.loginEnabled}" class="badge bg-secondary">Disabled</span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-warning"
                                    th:onclick="editStore([[${st.id}]], [[${st.name}]], [[${st.location}]], [[${st.loginEnabled}]], [[${st.gstNumber}]], [[${st.address}]], [[${st.contactPerson}]], [[${st.mobileNumber}]], [[${st.email}]], [[${st.companyId}]])">Edit</button>
                                <form th:action="@{/admin/setup/store/delete/{id}(id=${st.id})}" method="post"
                                    style="display:inline;">
                                    <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                                </form>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- User Tab -->
            <div class="tab-pane fade" id="user" role="tabpanel">
                <div class="card border-0 shadow-sm mt-3">
                    <div class="card-body">
                        <h3>Add User</h3>
                        <form method="post" th:action="@{/admin/setup/user}" th:object="${user}">
                            <input type="hidden" id="userId" name="id" />
                            <div class="mb-3">
                                <label for="username" class="form-label">Username</label>
                                <input type="text" class="form-control" id="username" name="username"
                                    th:field="*{username}">
                            </div>
                            <div class="mb-3">
                                <label for="password" class="form-label">Password</label>
                                <input type="password" class="form-control" id="password" name="password"
                                    th:field="*{password}">
                                <div class="form-text">Leave blank to keep existing password when editing.</div>
                            </div>
                            <div class="mb-3">
                                <label for="role" class="form-label">Role</label>
                                <select class="form-select" id="role" name="role">
                                    <option value="">Select Role</option>
                                    <option value="ADMIN">ADMIN</option>
                                    <option value="COMPANY_ADMIN">COMPANY_ADMIN</option>
                                    <option value="STORE_USER">STORE_USER</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="userCompany" class="form-label">Company</label>
                                <select class="form-select" id="userCompany" name="companyId">
                                    <option value="">Select Company</option>
                                    <option th:each="comp : ${companies}" th:value="${comp.id}" th:text="${comp.name}">
                                    </option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="userStore" class="form-label">Store</label>
                                <select class="form-select" id="userStore" name="storeId">
                                    <option value="">Select Store</option>
                                    <option th:each="st : ${stores}" th:value="${st.id}" th:text="${st.name}"></option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">Save</button>
                        </form>
                    </div>
                </div>

                <h4 class="mt-4">Existing Users</h4>
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Username</th>
                            <th>Role</th>
                            <th>Company</th>
                            <th>Store</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="u : ${users}">
                            <td th:text="${u.id}"></td>
                            <td th:text="${u.username}"></td>
                            <td th:text="${u.role}"></td>
                            <td th:text="${u.company != null ? u.company.name : '-'}"></td>
                            <td th:text="${u.store != null ? u.store.name : '-'}"></td>
                            <td>
                                <button class="btn btn-sm btn-warning"
                                    th:onclick="editUser([[${u.id}]], [[${u.username}]], [[${u.role}]], [[${u.company?.id}]], [[${u.store?.id}]])">Edit</button>
                                <form th:action="@{/admin/setup/user/delete/{id}(id=${u.id})}" method="post"
                                    style="display:inline;">
                                    <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                                </form>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

        </div>
    </div>

    <script th:inline="javascript">
        function editCompany(id, name) {
            document.getElementById('companyId').value = id;
            document.getElementById('companyName').value = name;
        }
        function editStore(id, name, location, loginEnabled, gst, address, person, mobile, email, companyId) {
            document.getElementById('storeId').value = id;
            document.getElementById('storeName').value = name;
            document.getElementById('storeLocation').value = location;
            document.getElementById('storeLoginEnabled').checked = loginEnabled;
            document.getElementById('storeGst').value = gst || '';
            document.getElementById('storeAddress').value = address || '';
            document.getElementById('storePerson').value = person || '';
            document.getElementById('storeMobile').value = mobile || '';
            document.getElementById('storeEmail').value = email || '';
            const companySelect = document.getElementById('storeCompany');
            if (companySelect) companySelect.value = companyId || '';
        }
        function editUser(id, username, role, companyId, storeId) {
            document.getElementById('userId').value = id;
            document.getElementById('username').value = username;
            document.getElementById('role').value = role || '';
            document.getElementById('userCompany').value = companyId || '';
            document.getElementById('userStore').value = storeId || '';
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <footer th:replace="~{fragments :: footer}"></footer>
</body>

</html>